# 📘 技术方案：基于颜色特征的照片分簇归属算法

## 一、目标与背景
本方案旨在根据每张照片的主要颜色特征，判断其最接近的颜色簇（cluster），从而将照片自动归入相应的色系类别。  

核心思路：  
- 为每个簇定义一个或多个**颜色质心（centroid）**；  
- 对每张照片，提取其**5 个主色（含占比）**；  
- 计算该照片与各簇质心的距离；  
- 采用“**最近质心法 + 混合距离度量 + 拒识机制**”确定最终簇归属。

---

## 二、数据准备

### 2.1 照片主色提取  
- 对每张照片使用 **K-Means (k=5)** 或 `ColorThief` 提取 5 个主色。  
- 同时记录每个主色在图像中的**像素占比权重 wᵢ**。  

输出结构：
```json
{
  "photo_id": "P001",
  "colors": [
    {"rgb": [120, 180, 230], "weight": 0.45},
    {"rgb": [250, 200, 100], "weight": 0.30},
    {"rgb": [50, 60, 70], "weight": 0.15},
    {"rgb": [200, 100, 150], "weight": 0.07},
    {"rgb": [10, 200, 150], "weight": 0.03}
  ]
}
```

### 2.2 色系簇质心定义  
- 由人工或聚类算法事先确定每个簇的代表颜色。  
- 可为每个簇配置多个质心，以适应色域跨度（浅/深色系）。  

示例：
```json
{
  "clusters": {
    "warm": [[240, 160, 100], [220, 130, 80]],
    "cool": [[100, 180, 240], [80, 160, 220]],
    "neutral": [[120, 120, 120]]
  }
}
```

---

## 三、颜色距离度量

### 3.1 颜色空间转换  
RGB 转换为 **CIELAB** 空间，以获得符合人眼感知的色差度量。  

\$(L, a, b) = f(R, G, B)\$

### 3.2 距离函数  
采用 **ΔE2000** 作为颜色距离：

\$(d(c_1, c_2) = \Delta E_{2000}(c_1, c_2))\$

---

## 四、照片与簇的相似度计算

### 4.1 单个簇的距离计算  
给定照片主色集 `{cᵢ, wᵢ}` 与簇质心集 `{μⱼ}`，  
计算加权距离：

1. 对簇中每个质心 μⱼ：
   \$(D_{μⱼ} = \min_i ((\Delta E(c_i, μ_j)) / w_i^{\gamma}))\$  
   （γ ∈ [0.3, 0.7]，控制权重敏感度）  

2. 聚合簇内所有质心的最小距离：
   \$(D_{min} = \min_j D_{μⱼ})\$

3. 同时计算加权平均距离：
   \$(D_{avg} = \sum_i w_i · \Delta E(c_i, μ^*))\$  
   其中 μ* 为该簇中最优质心。

4. **混合距离：**
   \$(D_{mix} = α·D_{min} + (1-α)·D_{avg})\$  
   经验上 α=0.6。  

最终得到照片与每个簇的混合距离 `D_mix(k)`。

---

## 五、簇归属判定

### 5.1 最近质心法  
找出最小混合距离簇：  
\$(k^* = \arg\min_k D_{mix}(k))\$

### 5.2 拒识机制（Unknown 类别）

#### 阈值判断  
若 `D_mix(k*) > τ`，则照片归为 **“未知/未分配”**。  
阈值 τ 可通过统计样本集确定：  
\$(τ = median(D_{true}) + 2×MAD(D_{true}))\$  
若无样本经验，初值可设为 τ=20（ΔE 单位）。

#### 置信度判断  
为增加稳健性，引入 softmax 概率：

\$(p_k = \frac{e^{-D_{mix}(k)/σ}}{∑_j e^{-D_{mix}(j)/σ}})\$  
其中 σ≈10。  

若：  
- `p_{k*} < p₀`（置信度不足），或  
- `p_{k*} - p_{(2)} < δ`（簇间差距太小），  
则也归为 **未知**。  
推荐参数：`p₀=0.6`, `δ=0.2`。

---

## 六、输出结果

最终输出：
```json
{
  "photo_id": "P001",
  "assigned_cluster": "cool",
  "distance": 8.5,
  "probabilities": {"cool": 0.72, "warm": 0.20, "neutral": 0.08}
}
```

未通过阈值或置信度判断者输出：
```json
{
  "photo_id": "P002",
  "assigned_cluster": "unknown",
  "distance": 27.3
}
```

---

## 七、后续优化策略

1. **动态更新簇心**：  
   对“unknown”样本聚类，若形成新模式，可新增簇或调整质心。

2. **多质心管理**：  
   每个色系可维护多个质心，以覆盖浅、深、灰度变化。

3. **自适应参数调优**：  
   - 控制 unknown 比例在 5%~15%；  
   - 自动微调 τ 与 σ。

---

## 八、工程实现建议

- 编程语言：Python  
- 主要库：
  - `colorthief` 或 `skimage`（提取主色）
  - `colorspacious` 或 `colormath`（RGB↔Lab & ΔE2000）
  - `numpy / pandas`（数值与批处理）
- 输出格式：CSV 或 JSON，可直接导入 Notion/可视化工具。
