# Micro-Phase 5 实施计划（并发优化 + 自适应更新）

## 🎯 总目标

在 Phase 4 的基础上，将颜色分析系统提升到可面对真实使用场景的“高性能、可进化”形态。具体目标：

1. ⚡ **性能提升**：全流程并发化，提升处理吞吐量 2-4 倍
2. 🎨 **感知准确度**：引入 CIEDE2000，提高近似颜色分离能力
3. 🤖 **自适应能力**：根据质量指标自动合并/拆分/生成色簇
4. 🔁 **可持续运行**：引入缓存与增量分析，避免重复计算
5. 🧭 **交互反馈**：透明展示优化动作，让用户信任系统

---

## 🗂️ 模块拆分与责任

| 模块 | 目标 | 关键实现 |
|------|------|-----------|
| `ColorSpaceConverter` | 提供高精度色差计算 | 新增 CIEDE2000 实现；保留旧 ΔE 以便回退 |
| `SimpleColorExtractor` | 并行提取照片主色 | 采用 TaskGroup / async let 批处理 |
| `AutoKSelector` | 并发测试多组 K 值 | 改为并行执行 & 共享提取结果 |
| `AdaptiveClusterManager` *(新)* | 管理簇合并/拆分/生成 | 根据 ΔE、样本数和质量指标操作 |
| `AnalysisCache` *(新)* | 缓存单图和全局结果 | 基于 sha256 + Core Data/文件系统 |
| `SimpleAnalysisPipeline` | 调度并发、缓存、自适应 | 对接上述组件，维护流程 |
| `AnalysisHistoryView` / `AnalysisResultView` | 呈现优化动作 | 展示自适应日志、性能统计、缓存命中 |

---

## 🛠️ 实施阶段

### 阶段 A：核心算法升级（预计 12-15 次）
1. **CIEDE2000 实现**（`ColorSpaceConverter`）
   - 参考官方公式，支持并行/向量化
   - 单元测试覆盖典型颜色对
2. **ΔE2000 替换**（`SimpleKMeans` / `AutoKSelector` / `SimpleAnalysisPipeline`）
   - 聚类距离、质量评估、簇分配全部替换
   - 预留开关便于回退（例如 `useDeltaE2000` flag）

### 阶段 B：并发管线（预计 15-18 次）
1. 照片主色提取并行化（`SimpleColorExtractor` + pipeline 入口）
   - 使用 `TaskGroup` 按批次处理，控制并发度
   - 添加取消 & 错误收集机制
2. K 值测试并发化（`AutoKSelector`）
   - 为每个 K 启动子任务并行执行
   - 共享预先转换好的 LAB 数据，避免重复转换
3. 性能监控指标
   - 统计总耗时、并发任务数、平均耗时/张
   - 将统计结果写入 `AnalysisResult`

### 阶段 C：自适应聚类更新（预计 18-22 次）
1. 新增 `AdaptiveClusterManager`
   - 支持操作：合并、拆分、生成新簇、移除离群簇
   - 输入：聚类结果、ΔE矩阵、Silhouette、簇规模
   - 输出：调整后的簇数组、变更日志
2. 在 pipeline 中插入自适应逻辑
   - 聚类后根据规则调整
   - 更新 `AnalysisResult` 的日志和 quality metrics
3. 日志记录 & UI 显示
   - `AnalysisResult` 增加 `clusterAdjustments`
   - `AnalysisResultView` 展示这些调优动作

### 阶段 D：缓存与增量分析（预计 12-15 次）
1. 设计缓存模型
   - 单图缓存：`assetLocalIdentifier` + sha256 + 5主色 + 时间戳
   - 全局缓存：聚类摘要（Hash of sorted dominant colors）
2. Core Data 扩展 / 文件持久化
   - 新增实体或独立缓存目录
   - 清理策略：LRU / 过期时间
3. pipeline 集成
   - 分析前检查缓存是否可用
   - 记录命中率、节省的时间

### 阶段 E：UI & 压测（预计 10-12 次）
1. UI 改进
   - ProgressView 增加并发信息（当前/总任务、缓存命中数）
   - 结果页展示自适应调优记录、性能统计
2. 性能压测
   - 目标：300 张照片内 20s 完成
   - 记录 Phase 4 vs Phase 5 的耗时对比
3. 文档与总结
   - 更新 README / Phase 5 Summary
   - 输出性能对比图表、用户指南更新

---

## 🔍 自适应策略草案

1. **合并簇**
   - 条件：簇间 ΔE2000 < 5 且样本数均 < 10
   - 操作：合并并重新计算质心；记录日志
2. **拆分簇**
   - 条件：簇内平均 ΔE > 15 或 Silhouette < 0
   - 操作：对该簇内点重新运行 K=2 子聚类
3. **生成新簇**
   - 条件：存在离群颜色点，其 ΔE 与所有簇 > 25
   - 操作：创建新簇并标记为“候选”
4. **移除簇**
   - 条件：簇样本数 < 3 且 Silhouette 为负
   - 操作：标记为 `inactive`，不在 UI 中展示

这些阈值在实现时抽象为配置，便于后续调优。

---

## 📊 性能目标 (Phase 5 vs Phase 4)

| 指标 | Phase 4 | Phase 5 目标 |
|------|---------|---------------|
| 100 张照片耗时 | ~13 秒 | ≤ 6 秒 |
| 并发度 | 1 | 4-6 (可调) |
| 颜色命名准确率 | 基于 CSS | ΔE2000 校准，更贴近视觉感知 |
| 结果缓存命中率 | 0% | ≥ 50%（二次分析） |
| 自动调簇日志 | 无 | 显示合并/拆分/新增记录 |

---

## 📅 预估工作量

- 总体调用次数：**60-80 次**
  - 实现 + 测试 + 文档
- 时间范围：若保持当前节奏，约需 2-3 个工作日

---

## ✅ 准备事项

- [ ] 记录 Phase 4 性能基准（以便对比）
- [ ] 确认缓存方案（Core Data vs JSON 文件）
- [ ] 安排单元测试环境（尤其 CIEDE2000）
- [ ] 预留 UI 空间展示新指标

---

准备好后，我们先从 **阶段 A（ΔE2000）** 和 **阶段 B（并发管线）** 开始。任何调整需求随时可在计划上迭代。让我们进入 Micro-Phase 5！🚀

